<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexStack - Products</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script src="profile-icon.js"></script>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‹ All Products</h1>
            <p>View and manage your complete product inventory</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn" onclick="window.location.href='main.html'">Home</button>
            <button class="tab-btn" onclick="window.location.href='dashboard.html'">Dashboard</button>
            <button class="tab-btn active">Products</button>
            <button class="tab-btn" onclick="window.location.href='add-product.html'">Add Product</button>
            <button class="tab-btn" onclick="window.location.href='search.html'">Search</button>
            <button class="tab-btn" onclick="window.location.href='analytics.html'">Analytics</button>
        </div>

        <div class="card">
            <input id="search" placeholder="ðŸ” Search by name, ID, or price..." onkeyup="searchProduct()">
            
            <div class="sort-buttons">
                <button class="btn-primary btn-sm" onclick="sortByID()">Sort by ID</button>
                <button class="btn-primary btn-sm" onclick="sortByName()">Sort by Name</button>
                <button class="btn-primary btn-sm" onclick="sortByPrice()">Sort by Price</button>
            </div>

            <table id="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="body"></tbody>
            </table>
            <div id="empty-msg" class="empty-state">No products found. Add your first product!</div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div class="modal-header">Edit Product</div>
            <div class="form-group">
                <label for="editId">Product ID</label>
                <input type="number" id="editId" readonly>
            </div>
            <div class="form-group">
                <label for="editName">Product Name</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label for="editPrice">Price (â‚¹)</label>
                <input type="number" id="editPrice" step="0.01">
            </div>
            <div class="form-group">
                <label for="editQuantity">Quantity</label>
                <input type="number" id="editQuantity">
            </div>
            <div class="action-buttons">
                <button class="btn-success" onclick="saveProduct()">Save Changes</button>
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sell Product Modal -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSellModal()">&times;</span>
            <div class="modal-header">Sell Product</div>
            <div class="form-group">
                <label for="sellProductName">Product Name</label>
                <input type="text" id="sellProductName" readonly>
            </div>
            <div class="form-group">
                <label for="sellCurrentQty">Current Quantity</label>
                <input type="number" id="sellCurrentQty" readonly>
            </div>
            <div class="form-group">
                <label for="sellQuantity">Quantity to Sell</label>
                <input type="number" id="sellQuantity" min="1">
            </div>
            <div class="action-buttons">
                <button class="btn-success" onclick="processSell()">Confirm Sell</button>
                <button class="btn-secondary" onclick="closeSellModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rent Product Modal -->
    <div id="rentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRentModal()">&times;</span>
            <div class="modal-header">Rent Product</div>
            <div class="form-group">
                <label for="rentProductName">Product Name</label>
                <input type="text" id="rentProductName" readonly>
            </div>
            <input type="hidden" id="rentProductId">
            <div class="form-group">
                <label for="rentName">Renter Name *</label>
                <input type="text" id="rentName" placeholder="Full name">
            </div>
            <div class="form-group">
                <label for="rentPhone">Phone Number *</label>
                <input type="tel" id="rentPhone" placeholder="10-digit phone">
            </div>
            <div class="form-group">
                <label for="rentAddress">Address *</label>
                <textarea id="rentAddress" placeholder="Full address" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="rentReturnDate">Return Date *</label>
                <input type="date" id="rentReturnDate">
            </div>
            <div class="form-group">
                <label for="rentAmount">Amount Paid (â‚¹) *</label>
                <input type="number" id="rentAmount" step="0.01" placeholder="0.00">
            </div>
            <div class="action-buttons">
                <button class="btn-success" onclick="processRent()">Record Rental</button>
                <button class="btn-secondary" onclick="closeRentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Developed by Naren S J</p>
        <p class="footer-copyright">NexStock Â© 2025</p>
    </footer>
    
    <script>
        let allProducts = [];

        async function loadData() {
            try {
                const res = await fetch("/api/products");
                if (!res.ok) throw new Error("Failed to load inventory");
                allProducts = await res.json();
                displayProducts();
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        function displayProducts() {
            const tbody = document.getElementById("body");
            const emptyMsg = document.getElementById("empty-msg");

            if (allProducts.length === 0) {
                tbody.innerHTML = "";
                emptyMsg.style.display = "block";
                return;
            }

            emptyMsg.style.display = "none";
            tbody.innerHTML = allProducts.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>â‚¹${p.price.toFixed(2)}</td>
                    <td>${p.quantity}</td>
                    <td>â‚¹${(p.price * p.quantity).toFixed(2)}</td>
                    <td>
                        <button class="btn-info btn-sm" onclick="openEditModal(${p.id})">Edit</button>
                        <button class="btn-success btn-sm" onclick="openSellModal(${p.id})">Sell</button>
                        <button class="btn-warning btn-sm" onclick="openRentModal(${p.id})">Rent</button>
                        <button class="btn-danger btn-sm" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join("");
        }

        function searchProduct() {
            const filter = document.getElementById("search").value.toLowerCase();
            const rows = document.querySelectorAll("#table tbody tr");

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        }

        function sortByID() {
            allProducts.sort((a, b) => a.id - b.id);
            displayProducts();
        }

        function sortByName() {
            allProducts.sort((a, b) => a.name.localeCompare(b.name));
            displayProducts();
        }

        function sortByPrice() {
            allProducts.sort((a, b) => a.price - b.price);
            displayProducts();
        }

        function openEditModal(id) {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                document.getElementById("editId").value = product.id;
                document.getElementById("editName").value = product.name;
                document.getElementById("editPrice").value = product.price;
                document.getElementById("editQuantity").value = product.quantity;
                document.getElementById("editModal").classList.add("active");
            }
        }

        async function saveProduct() {
            const id = parseInt(document.getElementById("editId").value);
            const name = document.getElementById("editName").value.trim();
            const price = parseFloat(document.getElementById("editPrice").value);
            const quantity = parseInt(document.getElementById("editQuantity").value);

            if (!name || price <= 0 || quantity <= 0) {
                alert("Please fill all fields correctly");
                return;
            }

            try {
                const res = await fetch("/api/products", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, name, price, quantity })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || "Failed to update product");
                }
                
                await loadData();
                closeModal();
                alert("Product updated successfully!");
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to update product: " + error.message);
            }
        }

        function closeModal() {
            document.getElementById("editModal").classList.remove("active");
        }

        function openSellModal(id) {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                document.getElementById("sellProductName").value = product.name;
                document.getElementById("sellCurrentQty").value = product.quantity;
                document.getElementById("sellQuantity").value = '';
                document.getElementById("sellQuantity").dataset.productId = id;
                document.getElementById("sellModal").classList.add("active");
            }
        }

        function closeSellModal() {
            document.getElementById("sellModal").classList.remove("active");
        }

        async function processSell() {
            const quantityToSell = parseInt(document.getElementById("sellQuantity").value);
            const productId = parseInt(document.getElementById("sellQuantity").dataset.productId);
            const currentQty = parseInt(document.getElementById("sellCurrentQty").value);

            if (!quantityToSell || quantityToSell <= 0) {
                alert("Please enter a valid quantity");
                return;
            }

            if (quantityToSell > currentQty) {
                alert("Cannot sell more than available quantity");
                return;
            }

            try {
                const res = await fetch("/api/sell", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ productId, quantitySold: quantityToSell })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || "Failed to sell product");
                }

                const result = await res.json();
                await loadData();
                closeSellModal();
                alert(`Sold ${quantityToSell} unit(s)! New quantity: ${result.product.quantity}`);
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to sell product: " + error.message);
            }
        }

        function openRentModal(id) {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                document.getElementById("rentProductName").value = product.name;
                document.getElementById("rentProductId").value = id;
                // Clear form
                document.getElementById("rentName").value = '';
                document.getElementById("rentPhone").value = '';
                document.getElementById("rentAddress").value = '';
                document.getElementById("rentReturnDate").value = '';
                document.getElementById("rentAmount").value = '';
                document.getElementById("rentModal").classList.add("active");
            }
        }

        function closeRentModal() {
            document.getElementById("rentModal").classList.remove("active");
        }

        async function processRent() {
            const productId = parseInt(document.getElementById("rentProductId").value);
            const renterName = document.getElementById("rentName").value.trim();
            const phoneNumber = document.getElementById("rentPhone").value.trim();
            const address = document.getElementById("rentAddress").value.trim();
            const returnDate = document.getElementById("rentReturnDate").value;
            const amountPaid = parseFloat(document.getElementById("rentAmount").value);

            if (!renterName || !phoneNumber || !address || !returnDate || !amountPaid) {
                alert("Please fill all fields");
                return;
            }

            if (phoneNumber.length < 10) {
                alert("Please enter a valid phone number");
                return;
            }

            if (amountPaid <= 0) {
                alert("Amount paid must be greater than 0");
                return;
            }

            try {
                const res = await fetch("/api/rent", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ productId, renterName, phoneNumber, address, returnDate, amountPaid })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || "Failed to record rental");
                }

                const result = await res.json();
                closeRentModal();
                alert(`Rental recorded successfully!\nRental ID: ${result.rental.rentalId}`);
                // Redirect to rentals page after delay
                setTimeout(() => {
                    window.location.href = 'rentals.html';
                }, 1500);
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to record rental: " + error.message);
            }
        }

        async function deleteProduct(id) {
            if (confirm("Are you sure you want to delete this product?")) {
                try {
                    const productId = parseInt(id);
                    const res = await fetch("/api/products", {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id: productId })
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to delete product");
                    }
                    
                    await loadData();
                    alert("Product deleted successfully!");
                } catch (error) {
                    console.error("Error:", error);
                    alert("Failed to delete product: " + error.message);
                }
            }
        }

        function showSuccess(msg) {
            alert(msg);
        }

        loadData();
    </script>
</body>
</html>
